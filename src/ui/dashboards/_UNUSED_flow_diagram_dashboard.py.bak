"""
Flow Diagram Dashboard Controller (FLOW VISUALIZATION).

Purpose:
- Load flow_diagram.ui (container with QGraphicsView)
- Load JSON diagram data
- Create FlowDiagramScene with zones, nodes, edges
- Load volumes from Excel
- Handle zoom/pan/refresh controls

Data Flow:
1. Load diagram JSON (nodes, edges, zones positioning)
2. Create QGraphicsScene with all items
3. Set scene on QGraphicsView
4. Load volumes from Excel
5. Update edge volume labels
6. Handle toolbar actions (zoom, refresh, save)
"""

from PySide6.QtWidgets import QWidget, QMessageBox
from PySide6.QtCore import Qt
from pathlib import Path
import json
from datetime import date

from ui.dashboards.generated_ui_flow_diagram import Ui_Form
from ui.components.flow_diagram_scene import FlowDiagramScene


class FlowDiagramPage(QWidget):
    """Flow Diagram Dashboard (VISUALIZATION ENGINE).
    
    Displays interactive water flow diagram with:
    - Zones (background areas grouping components)
    - Nodes (components: sources, plants, TSF, etc)
    - Edges (flow paths with volumes from Excel)
    - Toolbar controls (zoom, refresh, save)
    
    Data Sources:
    - JSON diagram: data/diagrams/{area_code}_*.json (positions, structure)
    - Excel volumes: Legacy Excel "Meter Readings" via flow_volume_loader
    """
    
    def __init__(self, parent=None, area_code: str = "UG2N"):
        """Initialize Flow Diagram page.
        
        Args:
            parent: Parent widget (usually MainWindow)
            area_code: Area code for diagram (e.g., 'UG2N', 'OLDTSF')
        """
        super().__init__(parent)
        
        print(f"‚úì FlowDiagramPage.__init__() called for area: {area_code}")
        
        self.area_code = area_code
        self.scene = None
        self.current_volumes = {}
        
        # Load compiled UI
        self.ui = Ui_Form()
        self.ui.setupUi(self)
        print("‚úì UI setup complete")
        
        # Load diagram JSON
        self.diagram_data = self._load_diagram_json(area_code)
        
        if self.diagram_data:
            # Create and set graphics scene
            self.scene = FlowDiagramScene(self.diagram_data)
            self.ui.graphicsView.setScene(self.scene)
            
            # Load volumes from Excel
            self._load_volumes_from_excel()
        else:
            pass  # Silently continue if no diagram
        
        # Connect all toolbar buttons to actions
        self._connect_buttons()
        print("‚úì All buttons connected")
        print(f"‚úì FlowDiagramPage ready! load_excel_button connected: {hasattr(self.ui, 'load_excel_button')}")
    
    def _load_diagram_json(self, area_code: str) -> dict:
        """Load diagram JSON file for given area code.
        
        Searches in multiple locations:
        1. Local project diagrams folder
        2. Tkinter project diagrams folder (fallback)
        
        Args:
            area_code: Area code (e.g., 'UG2N', 'OLDTSF')
            
        Returns:
            Parsed JSON dict or None if not found
        """
        # Area code to filename mapping
        area_filename_map = {
            'UG2N': 'ug2_north_decline.json',
            'UG2S': 'ug2_south_area.json',
            'OLDTSF': 'old_tsf.json',
            'NEWTSF': 'new_tsf.json',
            'PLANT': 'ug2_plant_area.json',
            'STOCK': 'stockpile_area.json',
        }
        
        filename = area_filename_map.get(area_code, f"{area_code.lower()}_diagram.json")
        
        # Search paths (in order of preference)
        search_paths = [
            # 1. Local project
            Path('data/diagrams') / filename,
            # 2. Tkinter project (fallback)
            Path('c:/PROJECTS/Water-Balance-Application/data/diagrams') / filename,
            # 3. Absolute path
            Path(f'c:\\PROJECTS\\Water-Balance-Application\\data\\diagrams\\{filename}'),
        ]
        
        for path in search_paths:
            if path.exists():
                try:
                    with open(path, 'r') as f:
                        data = json.load(f)
                        return data
                except Exception:
                    continue
        
        print(f"‚úó No diagram found for area: {area_code} in any of these paths:")
        for path in search_paths:
            print(f"  - {path}")
        return None
    
    def _load_volumes_from_excel(self):
        """Load flow volumes from Excel and update scene.
        
        TODO: Integrate with flow_volume_loader service.
        Currently loads placeholder data.
        
        In real implementation:
        - Use get_flow_volume_loader() service (from Tkinter)
        - Call loader.get_volumes_for_date(date.today())
        - Returns dict: {edge_id: volume_m3}
        """
        # TODO: Replace with actual service call
        # from services.flow_volume_loader import get_flow_volume_loader
        # loader = get_flow_volume_loader()
        # volumes = loader.get_volumes_for_date(date.today())
        
        # For now: Use placeholder volumes from diagram JSON
        placeholder_volumes = {}
        for idx, edge in enumerate(self.diagram_data.get('edges', [])):
            # Use explicit id if available, otherwise generate fallback
            edge_id = edge.get('id') or f"{edge.get('from', 'unknown')}_{edge.get('to', 'unknown')}_{idx}"
            volume = edge.get('volume', 1000)  # Default 1000 m¬≥
            placeholder_volumes[edge_id] = volume
        
        # Update scene with volumes
        if self.scene:
            self.scene.update_all_volumes(placeholder_volumes)
        
        self.current_volumes = placeholder_volumes
    
    def _connect_buttons(self):
        """Connect all toolbar buttons to their action handlers.
        
        Buttons connected:
        - Zoom: zoom_in_button, zoom_out_button
        - Diagram: save_diagram_button
        - Flows: Draw_button, edit_flows_button, delete_folws_button (note: typo in UI)
        - Nodes: Add_button, edit_nodes_button, lock_nodes_button
        - Data: load_excel_button, excel_setup_button, balance_check_button
        - Other: pushButton_6 (generic button)
        """
        # Zoom controls
        self.ui.zoom_in_button.clicked.connect(self._on_zoom_in)
        self.ui.zoom_out_button.clicked.connect(self._on_zoom_out)
        
        # Diagram controls
        self.ui.save_diagram_button.clicked.connect(self._on_save)
        
        # Flow controls
        self.ui.Draw_button.clicked.connect(self._on_draw_flows)
        self.ui.edit_flows_button.clicked.connect(self._on_edit_flows)
        self.ui.delete_folws_button.clicked.connect(self._on_delete_flows)
        
        # Node controls
        self.ui.Add_button.clicked.connect(self._on_add_nodes)
        self.ui.edit_nodes_button.clicked.connect(self._on_edit_nodes)
        self.ui.lock_nodes_button.clicked.connect(self._on_lock_nodes)
        
        # Data controls
        print(f"Connecting load_excel_button (exists: {hasattr(self.ui, 'load_excel_button')})")
        if hasattr(self.ui, 'load_excel_button'):
            self.ui.load_excel_button.clicked.connect(self._on_load_excel)
            print(f"  ‚úì Connected to: {self._on_load_excel}")
        self.ui.excel_setup_button.clicked.connect(self._on_excel_setup)
        self.ui.balance_check_button.clicked.connect(self._on_balance_check)
        
        print("‚úì Data controls connected (load_excel, excel_setup, balance_check)")
        
        # Generic button
        self.ui.pushButton_6.clicked.connect(self._on_generic_action)
    
    def _on_zoom_in(self):
        """Zoom in by 20%."""
        print("üîç ZOOM IN CLICKED!")
        self.ui.graphicsView.scale(1.2, 1.2)
        print("Zoom: +20%")
    
    def _on_zoom_out(self):
        """Zoom out by 20%."""
        self.ui.graphicsView.scale(1 / 1.2, 1 / 1.2)
        print("Zoom: -20%")
    
    def _on_fit_view(self):
        """Fit entire diagram to view."""
        if self.scene:
            self.ui.graphicsView.fitInView(
                self.scene.sceneRect(),
                Qt.AspectRatioMode.KeepAspectRatio
            )
        print("View: Fit to screen")
    
    def _on_refresh(self):
        """Reload volumes from Excel and update display.
        
        Useful when Excel data has changed and user wants
        to see updated volumes on the diagram.
        """
        self._load_volumes_from_excel()
        print("‚úì Volumes refreshed from Excel")
    
    def _on_save(self):
        """Save diagram.
        
        TODO: Implement diagram export/save functionality.
        - Save as SVG (scalable)
        - Save as PNG (raster)
        - Save diagram JSON with edits
        """
        QMessageBox.information(self, "Save Diagram",
            "Save functionality not yet implemented.\n\n"
            "Planned features:\n"
            "- Export as SVG\n"
            "- Export as PNG\n"
            "- Save edits to JSON")
        print("Save: Not implemented yet")
    
    # Flow control handlers
    def _on_draw_flows(self):
        """Toggle draw flows mode."""
        print("Draw flows: Toggled")
        QMessageBox.information(self, "Draw Flows",
            "Draw flows mode activated.\n\n"
            "Click on nodes to create flows.\n"
            "(Implementation pending)")
    
    def _on_edit_flows(self):
        """Edit flow properties."""
        print("Edit flows: Triggered")
        QMessageBox.information(self, "Edit Flows",
            "Edit flows dialog.\n\n"
            "(Implementation pending)")
    
    def _on_delete_flows(self):
        """Delete selected flows."""
        print("Delete flows: Triggered")
        QMessageBox.information(self, "Delete Flows",
            "Delete flows dialog.\n\n"
            "(Implementation pending)")
    
    # Node control handlers
    def _on_add_nodes(self):
        """Add new nodes to diagram."""
        print("Add nodes: Triggered")
        QMessageBox.information(self, "Add Nodes",
            "Add new nodes dialog.\n\n"
            "(Implementation pending)")
    
    def _on_edit_nodes(self):
        """Edit node properties."""
        print("Edit nodes: Triggered")
        QMessageBox.information(self, "Edit Nodes",
            "Edit nodes dialog.\n\n"
            "(Implementation pending)")
    
    def _on_lock_nodes(self):
        """Toggle node locking."""
        print("Lock nodes: Toggled")
        QMessageBox.information(self, "Lock Nodes",
            "Node locking toggled.\n\n"
            "(Implementation pending)")
    
    # Data control handlers
    def _on_load_excel(self):
        """Load data from Excel file (USER ACTION).
        
        Checks if Excel file is configured before loading.
        Shows helpful error message if not configured.
        
        User workflow:
        1. Click "Load Excel" button
        2. If Excel not configured ‚Üí pop-up directs to Excel Setup
        3. If Excel configured ‚Üí load volumes and show success message
        """
        print("="*80)
        print("üî• LOAD EXCEL BUTTON CLICKED! _on_load_excel() CALLED")
        print("="*80)
        
        try:
            print("Load Excel: Triggered - checking Excel configuration...")
            
            # Check if Excel is configured via ExcelManager
            try:
                from services.excel_manager import ExcelManager
                excel_mgr = ExcelManager()
                
                # Check if Excel file is loaded
                if not hasattr(excel_mgr, 'file_path') or not excel_mgr.file_path:
                    print("Excel not configured - showing warning dialog")
                    QMessageBox.warning(self, "Excel File Not Configured",
                        "Please configure the Excel file path first.\n\n"
                        "Click 'Excel Setup' button to browse and select your Excel file.")
                    return
                
                # Check if file exists
                if not Path(excel_mgr.file_path).exists():
                    print(f"Excel file not found - showing warning dialog")
                    QMessageBox.warning(self, "Excel File Not Found",
                        "The configured Excel file does not exist.\n\n"
                        "Please check the file path in Excel Setup.")
                    return
                    
                print("Excel configured and exists - loading volumes...")
            except Exception as e:
                print(f"Error checking Excel configuration: {e}")
                QMessageBox.warning(self, "Excel File Not Configured",
                    "Please configure the Excel file path first.\n\n"
                    "Click 'Excel Setup' button to browse and select your Excel file.")
                return
            
            # Load volumes from Excel
            self._load_volumes_from_excel()
            QMessageBox.information(self, "Load Excel",
                "Excel data loaded successfully.\n\n"
                "Diagram volumes updated.")
        except Exception as e:
            print(f"‚ùå EXCEPTION IN _on_load_excel: {e}")
            import traceback
            traceback.print_exc()
            QMessageBox.critical(self, "Error", f"An error occurred:\n{e}")
            "Excel data loaded successfully.\n\n"
            "Diagram volumes updated.")
    
    def _on_excel_setup(self):
        """Configure Excel file settings (OPENS DIALOG).
        
        Opens Excel Setup dialog where user can:
        - Browse to select Excel file
        - Map flow columns to diagram edges
        - Auto-create missing columns
        - Preview and edit Excel data
        """
        print("Excel setup: Triggered")
        
        # Import dialog (deferred to avoid circular imports)
        from ui.dialogs.excel_setup_dialog import ExcelSetupDialog
        
        # Open dialog
        dialog = ExcelSetupDialog(self)
        dialog.exec()  # Modal dialog - blocks until closed
        
        # After dialog closes, reload volumes to reflect any changes
        self._load_volumes_from_excel()
    
    def _on_balance_check(self):
        """Run balance check on current data."""
        print("Balance check: Triggered")
        QMessageBox.information(self, "Balance Check",
            "Balance check dialog.\n\n"
            "(Implementation pending)")
    
    def _on_generic_action(self):
        """Generic button action (placeholder)."""
        print("Generic action: Triggered")
        QMessageBox.information(self, "Generic Action",
            "Generic button action.\n\n"
            "(Purpose TBD)")
    
    def update_area(self, new_area_code: str):
        """Switch to different area diagram.
        
        Useful for navigation between mining areas.
        
        Args:
            new_area_code: New area code (e.g., 'UG2S', 'OLDTSF')
        """
        self.area_code = new_area_code
        self.diagram_data = self._load_diagram_json(new_area_code)
        
        if self.diagram_data:
            # Clear old scene
            self.ui.graphicsView.setScene(None)
            
            # Create new scene
            self.scene = FlowDiagramScene(self.diagram_data)
            self.ui.graphicsView.setScene(self.scene)
            
            # Load volumes for new area
            self._load_volumes_from_excel()
            
            # Fit to view
            self._on_fit_view()
            
            print(f"‚úì Switched to: {self.diagram_data.get('title')}")
        else:
            QMessageBox.warning(self, "Error",
                f"Could not load diagram for area: {new_area_code}")
