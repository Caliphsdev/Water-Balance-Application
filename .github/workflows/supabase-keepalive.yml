# Supabase Keep-Alive Workflow
# Prevents Supabase free tier from pausing after 7 days of inactivity
# Runs daily at midnight UTC to ping the database

name: Supabase Keep-Alive

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  ping:
    name: Ping Supabase Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Heartbeat Query
        run: |
          echo "Pinging Supabase to prevent free tier pause..."

          if [ -z "${{ secrets.SUPABASE_URL }}" ] || [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "Missing SUPABASE_URL or SUPABASE_ANON_KEY secrets"
            exit 1
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/keepalive?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          CURL_EXIT=$?
          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "Curl failed with exit code $CURL_EXIT"
            exit $CURL_EXIT
          fi
          
          if [ "$STATUS" = "200" ]; then
            echo "✅ Supabase ping successful (HTTP $STATUS)"
          else
            echo "⚠️ Supabase ping returned HTTP $STATUS"
            echo "Response body: $BODY"
            exit 1
          fi
      
      - name: Log Timestamp
        run: |
          echo "Keep-alive completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
