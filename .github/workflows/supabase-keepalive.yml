# Supabase Keep-Alive Workflow
# Prevents Supabase free tier from pausing after 7 days of inactivity
# Runs daily at midnight UTC to ping the database

name: Supabase Keep-Alive

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  ping:
    name: Ping Supabase Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Heartbeat Query
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Pinging Supabase to prevent free tier pause..."

          SUPABASE_URL=$(echo "$SUPABASE_URL" | tr -d '\r' | xargs)
          SUPABASE_ANON_KEY=$(echo "$SUPABASE_ANON_KEY" | tr -d '\r' | xargs)

          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "Missing SUPABASE_URL or SUPABASE_ANON_KEY secrets"
            exit 1
          fi

          if ! echo "$SUPABASE_URL" | grep -qE '^https?://'; then
            echo "SUPABASE_URL is not a valid http(s) URL"
            exit 1
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${SUPABASE_URL}/rest/v1/keepalive?select=id&limit=1" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")
          CURL_EXIT=$?
          BODY=$(echo "$RESPONSE" | head -n -1)
          STATUS=$(echo "$RESPONSE" | tail -n 1)

          if [ "$CURL_EXIT" -ne 0 ]; then
            echo "Curl failed with exit code $CURL_EXIT"
            exit $CURL_EXIT
          fi
          
          if [ "$STATUS" = "200" ]; then
            echo "✅ Supabase ping successful (HTTP $STATUS)"
          else
            echo "⚠️ Supabase ping returned HTTP $STATUS"
            echo "Response body: $BODY"
            exit 1
          fi
      
      - name: Log Timestamp
        run: |
          echo "Keep-alive completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
